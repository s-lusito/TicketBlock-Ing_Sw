@startuml Registrazione Utente
!theme plain
title Diagramma di Sequenza - Registrazione Utente

actor Client
participant AuthenticationController
participant AuthenticationService
participant UserRepository
participant WalletRepository

Client -> AuthenticationController: Richiesta registrazione
AuthenticationController -> AuthenticationService: Elabora registrazione

AuthenticationService -> UserRepository: Verifica email esistente

alt Email già registrata
    AuthenticationService --> Client: Errore: utente già registrato
end

AuthenticationService -> WalletRepository: Verifica wallet disponibili

alt Nessun wallet disponibile
    AuthenticationService --> Client: Errore: nessun wallet disponibile
end

AuthenticationService -> WalletRepository: Alloca wallet libero

AuthenticationService -> AuthenticationService: Crea utente con password hashata
note right of AuthenticationService: Password protetta con BCrypt\nAssocia wallet all'utente

AuthenticationService -> UserRepository: Salva nuovo utente

AuthenticationService -> AuthenticationService: Genera token JWT
note right of AuthenticationService: Access token e refresh token

AuthenticationService --> AuthenticationController: Token di autenticazione
AuthenticationController --> Client: Registrazione completata con successo

@enduml
