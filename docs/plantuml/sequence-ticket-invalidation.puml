@startuml Invalidazione Biglietto
!theme plain
title Diagramma di Sequenza - Invalidazione Biglietto

actor Client
participant TicketController
participant TicketService
participant BlockchainContract
participant TicketRepository

Client -> TicketController: Richiesta invalidazione biglietto
TicketController -> TicketService: Elabora invalidazione

TicketService -> TicketRepository: Recupera biglietto

alt Biglietto non trovato
    TicketService --> Client: Errore: biglietto non trovato
end

alt Utente non è proprietario
    TicketService --> Client: Errore: accesso negato
end

TicketService -> BlockchainContract: Verifica proprietà su blockchain
note right of BlockchainContract: Conferma proprietà prima dell'invalidazione
alt Errore blockchain
    BlockchainContract --> TicketService: Errore: verifica fallita
    TicketService --> Client: Errore: impossibile verificare proprietà
else Verifica proprietà fallita
    TicketService --> Client: Errore: proprietà non verificata
end

TicketService -> TicketService: Imposta stato INVALIDATED
TicketService -> TicketRepository: Salva modifiche

TicketService -> BlockchainContract: Brucia NFT
note right of BlockchainContract: Il biglietto diventa\npermanentemente invalido
alt Errore blockchain
    BlockchainContract --> TicketService: Errore: burn fallito
    TicketService --> Client: Errore: impossibile invalidare NFT
end

TicketService --> TicketController: Conferma invalidazione
TicketController --> Client: Biglietto invalidato con successo

@enduml
